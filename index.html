<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation Study</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .study-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .study-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .screen.active {
            display: block;
        }

        /* Full page info screen styles */
        .info-screen-full {
            background: white;
            min-height: 100vh;
            padding: 40px;
            line-height: 1.6;
        }

        .info-screen-full h2 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-align: center;
        }

        .info-screen-full h3 {
            color: #34495e;
            margin-top: 35px;
            margin-bottom: 20px;
            font-size: 1.4em;
            /* border-left: 4px solid #3498db;
            padding-left: 15px; */
        }

        .info-screen-full ul {
            margin: 15px 0;
            padding-left: 25px;
        }

        .info-screen-full li {
            margin: 10px 0;
        }

        .highlight {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
            margin: 20px 0;
            font-weight: 500;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-table th, .info-table td {
            border: 1px solid #ddd;
            padding: 15px;
            text-align: left;
        }

        .info-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .info-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        /* Consent section styles */
        .consent-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 40px;
            margin-top: 40px;
            border: 2px solid #3498db;
        }

        .consent-section h2 {
            color: #2c3e50;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2em;
            text-align: center;
        }

        .consent-intro {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            /*border-left: 5px solid #3498db;*/
            margin-bottom: 30px;
        }

        .consent-intro h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .consent-item {
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: white;
            border-radius: 8px;
            /*border-left: 4px solid #2ecc71;*/
        }

        .consent-item input[type="checkbox"] {
            margin-right: 15px;
            margin-top: 5px;
            transform: scale(1.2);
        }

        .consent-item label {
            font-size: 1.1em;
            line-height: 1.5;
        }

        .error {
            color: #e74c3c;
            font-size: 1em;
            margin-top: 15px;
            padding: 10px;
            background: #fdf2f2;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
        }

        .button-group {
            text-align: center;
            margin: 30px 0;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Rest of existing styles */
        .image-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .study-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .map-container {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
            cursor: crosshair !important;
        }

        .map-container * {
            cursor: crosshair !important;
        }

        .confidence-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }

        .confidence-slider-container {
            margin: 15px 0;
        }

        .confidence-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }

        .confidence-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .confidence-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .confidence-display {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .confidence-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .ai-predictions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #e74c3c;
        }

        .ai-teammate {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid;
        }

        .ai-teammate.ai-color-0 { border-left-color: #e74c3c; }
        .ai-teammate.ai-color-1 { border-left-color: #f39c12; }
        .ai-teammate.ai-color-2 { border-left-color: #9b59b6; }

        .teammate-info {
            flex: 1;
        }

        .teammate-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .teammate-location {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .ai-confidence-bar {
            width: 100px;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-left: 15px;
        }

        .ai-confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .revision-section {
            background: #fff3cd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .questionnaire {
            margin: 20px 0;
        }

        .question {
            margin: 20px 0;
        }

        .question label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .scale {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 500px;
            margin: 10px 0;
        }

        .scale input[type="radio"] {
            margin: 0 10px;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            max-width: 500px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }

        .instructions {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-complete {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
        }

        .loading-screen {
            background: white;
            border-radius: 15px;
            padding: 60px 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="study-header" id="studyHeader" style="display: none;">
            <h1>Human-AI Team Geolocation Study</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <p>Trial <span id="currentTrial">0</span> of <span id="totalTrials">10</span></p>
        </div>

        <!-- Participant Information and Consent Screen (Combined) -->
        <div class="screen active" id="infoScreen">
            <div class="info-screen-full">
                <h2>Participant Information Sheet</h2>
                
                <h3>Study Title: Team Trust Calibration in Human-AI Ensembles with Specialized Models for Geolocation Tasks</h3>
                
                <h3>Introduction</h3>
                <p>You are invited to take part in a research study. Please read this information sheet carefully before deciding whether to participate. It explains why the research is being conducted, what your participation will involve, and how your data will be used.</p>
                
                <h3>What is the purpose of the study?</h3>
                <p>The purpose of this study is to investigate how people interact with AI teammates during a geolocation task. It aims to understand trust and decision-making within human-AI teams that include multiple specialized AI models.</p>
                
                <h3>Why have I been invited to participate?</h3>
                <p>You have been invited because you are registered as a participant on Prolific. Approximately 100-200 participants will be recruited. We are recruiting individuals who meet the following criteria:</p>
                <ul>
                    <li>You are 18 years of age or older</li>
                    <li>You are fluent in English</li>
                    <li>You have normal or corrected-to-normal vision</li>
                    <li>You possess basic computer proficiency</li>
                    <li>You are not a professional working in AI</li>
                </ul>
                
                <h3>What will happen if I take part?</h3>
                <div class="highlight">
                    <p><strong>Single online session lasting approximately 25-35 minutes</strong></p>
                </div>
                
                <p><strong>What you will do:</strong></p>
                <ul>
                    <li>View <strong>10 indoor photographs</strong>, one at a time</li>
                    <li><strong>Guess the location</strong> where each photo was taken by placing a pin on a map</li>
                    <li>See predictions from several <strong>AI teammates</strong>, including their guessed locations, areas of expertise, and confidence levels</li>
                    <li>Option to <strong>revise your original guess</strong> based on AI input</li>
                    <li>Complete a <strong>short questionnaire</strong> about trust, confidence, and AI perception</li>
                </ul>
                
                <!-- <table class="info-table">
                    <tr>
                        <th>Step</th>
                        <th>What You Do</th>
                        <th>Duration</th>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>Read information and provide consent</td>
                        <td>3-4 mins</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Complete 10 location-guessing trials</td>
                        <td>20-25 mins</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Answer questionnaires</td>
                        <td>5-7 mins</td>
                    </tr>
                </table> -->
                
                <h3>Do I have to take part?</h3>
                <div class="highlight">
                    <p><strong>No, participation is entirely voluntary.</strong> You may withdraw at any time by closing your browser window. If you change your mind after submitting data, you can request deletion by contacting the researcher with your Prolific ID.</p>
                </div>
                
                <h3>What are the risks and benefits?</h3>
                <p><strong>Minimal risks:</strong> Time commitment (25-35 minutes), possible task fatigue, potential uncertainty with conflicting AI predictions.</p>
                <p><strong>Benefits:</strong></p>
                <ul>
                    <li><strong>Monetary compensation</strong> at Â£9/hour (pro-rata) through Prolific</li>
                    <li>Contribute to cutting-edge research on human-AI collaboration</li>
                </ul>
                
                <h3>Confidentiality and Data Protection</h3>
                <p>All information will be kept strictly confidential. No personally identifying information will be collected. Data will be stored securely on password-protected systems for 10 years, then destroyed. Anonymous data may be shared with other researchers or deposited in public repositories.</p>
                
                <h3>Who is organizing this research?</h3>
                <p>This project is organized by researchers from The University of Glasgow and funded by a research grant from The Alan Turing Institute. The study has been reviewed by the College of Medical, Veterinary & Life Sciences Ethics Committee.</p>
                
                <h3>Contact Information</h3>
                <p><strong>Researchers:</strong> Ogechi Onuoha (Ogechi.onuoha@glasgow.ac.uk), Yu Wa Ng (2600988N@student.gla.ac.uk)<br>
                <strong>Supervisor:</strong> Prof. Frank E. Pollick (frank.pollick@glasgow.ac.uk)</p>

                <!-- Consent Section - Now part of the same screen -->
                <div class="consent-section">
                    <h2>Participant Consent</h2>
                    <div class="consent-intro">
                        <h3>Consent to Participate</h3>
                        <p>By checking the boxes below, you confirm that you have read and understood the participant information sheet and agree to take part in this study.</p>
                    </div>
                    
                    <div class="consent-item">
                        <input type="checkbox" id="consent1" required>
                        <label for="consent1">I confirm that I have read and understood the Participant Information Sheet.</label>
                    </div>
                    
                    <div class="consent-item">
                        <input type="checkbox" id="consent2" required>
                        <label for="consent2">I understand that my participation is voluntary and that I am free to withdraw at any time without giving any reason.</label>
                    </div>
                    
                    <div class="consent-item">
                        <input type="checkbox" id="consent3" required>
                        <label for="consent3">I confirm that I agree to the way my data will be collected and processed and that data will be stored for up to 10 years.</label>
                    </div>
                    
                    <div class="consent-item">
                        <input type="checkbox" id="consent4" required>
                        <label for="consent4">I understand that all data and information I provide will be kept confidential.</label>
                    </div>
                    
                    <div class="consent-item">
                        <input type="checkbox" id="consent5" required>
                        <label for="consent5">I agree to take part in the study.</label>
                    </div>
                    
                    <div class="error" id="consentError" style="display: none;">Please check all consent boxes to continue.</div>
                    
                    <div class="button-group">
                        <button class="btn" onclick="startStudy()">Begin Study</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="screen" id="loadingScreen">
            <div class="loading-screen">
                <h2>Preparing Next Trial...</h2>
                <div class="loading-spinner"></div>
                <p>Please wait while we load the next image.</p>
            </div>
        </div>

        <!-- Demographics Screen -->
        <div class="screen" id="demographicsScreen">
            <h2>Background Information</h2>
            <div class="questionnaire">
                <div class="question">
                    <label for="age">Age:</label>
                    <input type="number" id="age" min="18" max="100" required>
                </div>
                
                <div class="question">
                    <label for="gender">Gender:</label>
                    <select id="gender" required>
                        <option value="">Please select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                
                <div class="question">
                    <label for="country">Country of residence:</label>
                    <select id="country" required>
                        <option value="">Please select</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="United States">United States</option>
                        <option value="Singapore">Singapore</option>
                        <option value="Thailand">Thailand</option>
                        <option value="Germany">Germany</option>
                        <option value="France">France</option>
                        <option value="Italy">Italy</option>
                        <option value="Spain">Spain</option>
                        <option value="Netherlands">Netherlands</option>
                        <option value="Poland">Poland</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="error" id="demographicsError" style="display: none;">Please complete all fields.</div>
            
            <div class="button-group">
                <button class="btn" onclick="startTrials()">Continue</button>
            </div>
        </div>

        <!-- Main Trial Screen -->
        <div class="screen" id="trialScreen">
            <h2>Location Guessing Task</h2>
            
            <div class="instructions">
                <p><strong>Instructions:</strong> Look at the image below and guess where this photo was taken by clicking on the map. Then rate your confidence in your guess using the slider.</p>
            </div>
            
            <div class="image-container">
                <img id="currentImage" class="study-image" src="" alt="Location to guess">
            </div>
            
            <div class="map-container" id="mapContainer"></div>
            
            <!-- Initial Confidence Section -->
            <div class="confidence-section" id="initialConfidenceSection">
                <h3>Your Confidence 
                    <span class="status-indicator status-pending" id="locationStatus">Select location first</span>
                </h3>
                <p>How confident are you in your location guess?</p>
                <div class="confidence-slider-container">
                    <input type="range" id="initialConfidenceSlider" class="confidence-slider" 
                           min="0" max="100" value="50" disabled>
                    <div class="confidence-display" id="initialConfidenceDisplay">50%</div>
                    <div class="confidence-labels">
                        <span>Not confident at all</span>
                        <span>Extremely confident</span>
                    </div>
                </div>
            </div>

            <!-- AI Predictions Section -->
            <div id="aiPredictions" class="ai-predictions" style="display: none;">
                <h3>AI Teammate Predictions</h3>
                <div id="aiTeammates"></div>
            </div>

            <!-- Revision Section -->
            <div id="revisionSection" class="revision-section" style="display: none;">
                <h3>Revise Your Answer (Optional)</h3>
                <p>After seeing the AI predictions, you can:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>Click on the map again to change your location guess</li>
                    <li>Adjust your confidence using the slider below</li>
                    <li>Or keep your original answer unchanged</li>
                </ul>
                
                <div class="confidence-slider-container">
                    <label for="finalConfidenceSlider"><strong>Updated Confidence:</strong></label>
                    <input type="range" id="finalConfidenceSlider" class="confidence-slider" 
                           min="0" max="100" value="50">
                    <div class="confidence-display" id="finalConfidenceDisplay">50%</div>
                    <div class="confidence-labels">
                        <span>Not confident at all</span>
                        <span>Extremely confident</span>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn" id="initialGuessBtn" onclick="showAIPredictions()" disabled>Confirm Initial Guess</button>
                <button class="btn" id="finalGuessBtn" onclick="nextTrial()" style="display: none;">Submit Final Answer</button>
            </div>
        </div>

        <!-- Post-trial Questionnaires -->
        <div class="screen" id="questionnaireScreen">
            <h2>Study Questions</h2>
            
            <div class="questionnaire">
                <div class="question">
                    <label>How much did you trust the AI teammates' predictions overall?</label>
                    <div class="scale">
                        <span>Not at all</span>
                        <input type="radio" name="trust" value="1" required>
                        <input type="radio" name="trust" value="2" required>
                        <input type="radio" name="trust" value="3" required>
                        <input type="radio" name="trust" value="4" required>
                        <input type="radio" name="trust" value="5" required>
                        <input type="radio" name="trust" value="6" required>
                        <input type="radio" name="trust" value="7" required>
                        <span>Completely</span>
                    </div>
                    <div class="scale-labels">
                        <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span>
                    </div>
                </div>
                
                <div class="question">
                    <label>How confident were you in your final decisions overall?</label>
                    <div class="scale">
                        <span>Not confident</span>
                        <input type="radio" name="confidence" value="1" required>
                        <input type="radio" name="confidence" value="2" required>
                        <input type="radio" name="confidence" value="3" required>
                        <input type="radio" name="confidence" value="4" required>
                        <input type="radio" name="confidence" value="5" required>
                        <input type="radio" name="confidence" value="6" required>
                        <input type="radio" name="confidence" value="7" required>
                        <span>Very confident</span>
                    </div>
                    <div class="scale-labels">
                        <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span>
                    </div>
                </div>
                
                <div class="question">
                    <label>Please describe your strategy for making location guesses and how the AI predictions influenced your decisions:</label>
                    <textarea id="strategy" placeholder="Please explain your approach..."></textarea>
                </div>
                
                <div class="question">
                    <label>Any additional comments about the study:</label>
                    <textarea id="comments" placeholder="Optional feedback..."></textarea>
                </div>
            </div>
            
            <div class="error" id="questionnaireError" style="display: none;">Please answer all required questions.</div>
            
            <div class="button-group">
                <button class="btn" onclick="completeStudy()">Complete Study</button>
            </div>
        </div>

        <!-- Completion Screen -->
        <div class="screen" id="completionScreen">
            <h2>Study Complete!</h2>
            <div class="instructions">
                <p>Thank you for participating in our study. Your responses have been recorded.</p>
                <p><strong>Completion Code:</strong> <span id="completionCode" style="font-family: monospace; background: #f8f9fa; padding: 5px 10px; border-radius: 5px;"></span></p>
                <p>Please copy this code and paste it into Prolific to receive your payment.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // CONFIGURATION - UPDATE THESE VALUES FOR YOUR STUDY
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxBP8lU6rcgBaZFt_t2zGmpnvIGF-kiSfcxqTvOy03Pxc1D8BlJjX_tsO9DJDdJlfW/exec';
        
        // AI marker colors - these correspond to the CSS classes
        const AI_COLORS = [
            { hex: '#e74c3c', class: 'ai-color-0' },
            { hex: '#f39c12', class: 'ai-color-1' },
            { hex: '#9b59b6', class: 'ai-color-2' }
        ];

        // Study images with ground truth locations and AI predictions (10 trials with more diverse locations)
        const studyImages = [
            {
                url: 'images/photo1.jpg', // Replace with your image paths
                groundTruth: { lat: 55.8642, lng: -4.2518 }, // Glasgow, UK
                description: 'University library',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 35.9100, lng: -4.1800, confidence: 0.45 },
                        { id: 'ai2', label: 'AI System 2', lat: 55.8650, lng: -42.2500, confidence: 0.87 },
                        { id: 'ai3', label: 'AI System 3', lat: 55.7800, lng: -14.3200, confidence: 0.62 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 55.8680, lng: -4.2450, confidence: 0.78 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 55.9200, lng: -4.1600, confidence: 0.41 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 55.8620, lng: -4.2550, confidence: 0.89 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 55.8670, lng: -4.2480, confidence: 0.81 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 55.8590, lng: -4.2600, confidence: 0.75 },
                        { id: 'geography', label: 'Geography Expert', lat: 55.8720, lng: -4.2380, confidence: 0.92 }
                    ]
                }
            },
            {
                url: 'images/photo2.jpg',
                groundTruth: { lat: 40.7589, lng: -73.9851 }, // New York, US
                description: 'Office building',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 30.6200, lng: -74.1500, confidence: 0.38 },
                        { id: 'ai2', label: 'AI System 2', lat: 50.7620, lng: -23.9800, confidence: 0.84 },
                        { id: 'ai3', label: 'AI System 3', lat: 40.8100, lng: -73.9200, confidence: 0.59 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 40.7550, lng: -73.9900, confidence: 0.76 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 40.6800, lng: -74.0800, confidence: 0.43 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 40.7640, lng: -73.9780, confidence: 0.88 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 40.7580, lng: -73.9840, confidence: 0.79 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 40.7720, lng: -73.9650, confidence: 0.71 },
                        { id: 'geography', label: 'Geography Expert', lat: 40.7610, lng: -73.9820, confidence: 0.91 }
                    ]
                }
            },
            {
                url: 'images/photo3.jpg',
                groundTruth: { lat: 51.5074, lng: -0.1278 }, // London, UK
                description: 'Conference room',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 41.4200, lng: -0.2800, confidence: 0.34 },
                        { id: 'ai2', label: 'AI System 2', lat: 31.5100, lng: -0.1200, confidence: 0.82 },
                        { id: 'ai3', label: 'AI System 3', lat: 51.5800, lng: -1.0500, confidence: 0.67 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 51.5080, lng: -0.1350, confidence: 0.74 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 51.4500, lng: -0.2200, confidence: 0.39 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 51.5120, lng: -0.1180, confidence: 0.86 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 51.5090, lng: -0.1290, confidence: 0.77 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 51.5150, lng: -0.1100, confidence: 0.69 },
                        { id: 'geography', label: 'Geography Expert', lat: 51.5060, lng: -0.1320, confidence: 0.89 }
                    ]
                }
            },
            {
                url: 'images/photo4.jpg',
                groundTruth: { lat: 48.8566, lng: 2.3522 }, // Paris, France
                description: 'Museum hall',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 48.7200, lng: 12.1800, confidence: 0.42 },
                        { id: 'ai2', label: 'AI System 2', lat: 38.8600, lng: 2.3400, confidence: 0.79 },
                        { id: 'ai3', label: 'AI System 3', lat: 48.9200, lng: 2.4800, confidence: 0.56 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 48.8520, lng: 2.3600, confidence: 0.73 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 48.7800, lng: 2.2400, confidence: 0.46 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 48.8580, lng: 2.3480, confidence: 0.83 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 48.8570, lng: 2.3530, confidence: 0.76 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 48.8620, lng: 2.3380, confidence: 0.68 },
                        { id: 'geography', label: 'Geography Expert', lat: 48.8540, lng: 2.3580, confidence: 0.87 }
                    ]
                }
            },
            {
                url: 'images/photo5.jpg',
                groundTruth: { lat: 35.6762, lng: 139.6503 }, // Tokyo, Japan
                description: 'Corporate office',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 25.5200, lng: 139.4800, confidence: 0.36 },
                        { id: 'ai2', label: 'AI System 2', lat: 45.6800, lng: 139.6400, confidence: 0.81 },
                        { id: 'ai3', label: 'AI System 3', lat: 35.7500, lng: 139.7800, confidence: 0.63 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 35.6750, lng: 139.6600, confidence: 0.72 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 35.5800, lng: 139.5200, confidence: 0.41 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 35.6820, lng: 139.6420, confidence: 0.85 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 35.6770, lng: 139.6510, confidence: 0.74 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 35.6920, lng: 139.6280, confidence: 0.66 },
                        { id: 'geography', label: 'Geography Expert', lat: 35.6740, lng: 139.6550, confidence: 0.90 }
                    ]
                }
            },
            {
                url: 'images/photo6.jpg',
                groundTruth: { lat: 52.5200, lng: 13.4050 }, // Berlin, Germany
                description: 'Research lab',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 51.4100, lng: 23.2500, confidence: 0.47 },
                        { id: 'ai2', label: 'AI System 2', lat: 42.5300, lng: 13.3900, confidence: 0.73 },
                        { id: 'ai3', label: 'AI System 3', lat: 12.6200, lng: 13.5800, confidence: 0.58 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 52.5150, lng: 13.4200, confidence: 0.68 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 52.4800, lng: 13.3200, confidence: 0.52 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 52.5280, lng: 13.3980, confidence: 0.80 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 52.5220, lng: 13.4080, confidence: 0.71 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 52.5380, lng: 13.3750, confidence: 0.64 },
                        { id: 'geography', label: 'Geography Expert', lat: 52.5180, lng: 13.4120, confidence: 0.85 }
                    ]
                }
            },
            {
                url: 'images/photo7.jpg',
                groundTruth: { lat: -33.8688, lng: 151.2093 }, // Sydney, Australia
                description: 'University classroom',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: -31.7200, lng: 151.0500, confidence: 0.44 },
                        { id: 'ai2', label: 'AI System 2', lat: -23.8750, lng: 151.1950, confidence: 0.76 },
                        { id: 'ai3', label: 'AI System 3', lat: -43.9800, lng: 151.3500, confidence: 0.61 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: -33.8650, lng: 151.2200, confidence: 0.69 },
                        { id: 'algo1', label: 'Algorithm 1', lat: -33.9200, lng: 151.1200, confidence: 0.48 },
                        { id: 'algo2', label: 'Algorithm 2', lat: -33.8720, lng: 151.2050, confidence: 0.82 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: -33.8700, lng: 151.2110, confidence: 0.73 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: -33.8820, lng: 151.1850, confidence: 0.67 },
                        { id: 'geography', label: 'Geography Expert', lat: -33.8670, lng: 151.2140, confidence: 0.88 }
                    ]
                }
            },
            {
                url: 'images/photo8.jpg',
                groundTruth: { lat: 45.4215, lng: -75.6972 }, // Ottawa, Canada
                description: 'Government office',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 45.3200, lng: -55.8500, confidence: 0.40 },
                        { id: 'ai2', label: 'AI System 2', lat: 45.4300, lng: -35.6800, confidence: 0.77 },
                        { id: 'ai3', label: 'AI System 3', lat: 45.5200, lng: -65.5500, confidence: 0.55 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 45.4180, lng: -75.7100, confidence: 0.70 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 45.3800, lng: -75.7800, confidence: 0.45 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 45.4250, lng: -75.6900, confidence: 0.84 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 45.4200, lng: -75.6980, confidence: 0.75 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 45.4350, lng: -75.6750, confidence: 0.62 },
                        { id: 'geography', label: 'Geography Expert', lat: 45.4190, lng: -75.7020, confidence: 0.89 }
                    ]
                }
            },
            {
                url: 'images/photo9.jpg',
                groundTruth: { lat: 55.6761, lng: 12.5683 }, // Copenhagen, Denmark
                description: 'Design studio',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 50.5800, lng: 12.4200, confidence: 0.43 },
                        { id: 'ai2', label: 'AI System 2', lat: 45.6850, lng: 12.5500, confidence: 0.78 },
                        { id: 'ai3', label: 'AI System 3', lat: 15.7500, lng: 12.6800, confidence: 0.59 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 50.6720, lng: 12.5800, confidence: 0.71 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 15.6200, lng: 12.4800, confidence: 0.49 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 59.6780, lng: 12.5620, confidence: 0.83 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 35.6750, lng: 12.5700, confidence: 0.74 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 55.6900, lng: 12.5450, confidence: 0.65 },
                        { id: 'geography', label: 'Geography Expert', lat: 55.6740, lng: 12.5720, confidence: 0.87 }
                    ]
                }
            },
            {
                url: 'images/photo10.jpg',
                groundTruth: { lat: 19.0760, lng: 72.8777 }, // Mumbai, India
                description: 'Tech startup office',
                aiPredictions: {
                    no_labels: [
                        { id: 'ai1', label: 'AI System 1', lat: 18.9200, lng: 72.7200, confidence: 0.39 },
                        { id: 'ai2', label: 'AI System 2', lat: 12.0850, lng: 72.8650, confidence: 0.75 },
                        { id: 'ai3', label: 'AI System 3', lat: 10.2100, lng: 73.0200, confidence: 0.57 }
                    ],
                    generic_labels: [
                        { id: 'manager', label: 'Manager', lat: 17.0720, lng: 72.8900, confidence: 0.68 },
                        { id: 'algo1', label: 'Algorithm 1', lat: 19.0200, lng: 72.8000, confidence: 0.46 },
                        { id: 'algo2', label: 'Algorithm 2', lat: 16.0800, lng: 72.8720, confidence: 0.81 }
                    ],
                    domain_labels: [
                        { id: 'manager', label: 'Manager', lat: 16.0770, lng: 72.8790, confidence: 0.72 },
                        { id: 'ethnicity', label: 'Ethnicity Expert', lat: 13.0950, lng: 72.8550, confidence: 0.63 },
                        { id: 'geography', label: 'Geography Expert', lat: 11.0750, lng: 72.8820, confidence: 0.86 }
                    ]
                }
            }
        ];

        // Study configuration
        const STUDY_CONFIG = {
            totalTrials: studyImages.length,
            conditions: ['no_labels'] //, 'generic_labels', 'domain_labels']
        };

        // Study state
        let currentTrial = 0;
        let condition = '';
        let map = null;
        let userMarker = null;
        let aiMarkers = [];
        let studyData = {
            participantId: generateParticipantId(),
            condition: '',
            demographics: {},
            trials: [],
            questionnaire: {},
            timestamps: {}
        };

        function generateParticipantId() {
            return 'P' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function updateProgress() {
            const progress = ((currentTrial) / STUDY_CONFIG.totalTrials) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentTrial').textContent = currentTrial;
            document.getElementById('totalTrials').textContent = STUDY_CONFIG.totalTrials;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Show/hide study header based on screen
            const studyHeader = document.getElementById('studyHeader');
            if (screenId === 'infoScreen' || screenId === 'demographicsScreen') {
                studyHeader.style.display = 'none';
            } else {
                studyHeader.style.display = 'block';
            }
        }

        function startStudy() {
            const consentBoxes = document.querySelectorAll('#infoScreen input[type="checkbox"]');
            const allChecked = Array.from(consentBoxes).every(box => box.checked);
            
            if (!allChecked) {
                document.getElementById('consentError').style.display = 'block';
                return;
            }

            // Randomly assign condition
            condition = STUDY_CONFIG.conditions[Math.floor(Math.random() * STUDY_CONFIG.conditions.length)];
            studyData.condition = condition;
            studyData.timestamps.consentCompleted = new Date().toISOString();

            showScreen('demographicsScreen');
        }

        function startTrials() {
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const country = document.getElementById('country').value;

            if (!age || !gender || !country) {
                document.getElementById('demographicsError').style.display = 'block';
                document.getElementById('demographicsError').textContent = 'Please complete all fields.';
                return;
            }

            if (parseInt(age) < 18) {
                document.getElementById('demographicsError').style.display = 'block';
                document.getElementById('demographicsError').textContent = 'You must be 18 years or older to participate in this study. Please return the study.';
                return;
            }

            studyData.demographics = { age: parseInt(age), gender, country };
            studyData.timestamps.trialsStarted = new Date().toISOString();
            
            currentTrial = 1;
            updateProgress();
            showLoadingScreen();
        }

        function showLoadingScreen() {
            showScreen('loadingScreen');
            // Show loading for 2.5 seconds, then proceed to trial
            setTimeout(() => {
                showScreen('trialScreen');
                initializeTrial();
            }, 2500);
        }

        function initializeTrial() {
            // Reset trial state
            document.getElementById('aiPredictions').style.display = 'none';
            document.getElementById('revisionSection').style.display = 'none';
            document.getElementById('initialGuessBtn').style.display = 'inline-block';
            document.getElementById('initialGuessBtn').disabled = true;
            document.getElementById('finalGuessBtn').style.display = 'none';
            document.getElementById('initialConfidenceSlider').disabled = true;
            document.getElementById('locationStatus').textContent = 'Select location first';
            document.getElementById('locationStatus').className = 'status-indicator status-pending';
            
            // Reset confidence sliders
            document.getElementById('initialConfidenceSlider').value = 50;
            document.getElementById('finalConfidenceSlider').value = 50;
            document.getElementById('initialConfidenceDisplay').textContent = '50%';
            document.getElementById('finalConfidenceDisplay').textContent = '50%';
            
            // Clear previous markers
            if (userMarker) {
                map.removeLayer(userMarker);
                userMarker = null;
            }
            aiMarkers.forEach(marker => map.removeLayer(marker));
            aiMarkers = [];

            // Set current image
            const currentImageData = studyImages[currentTrial - 1];
            document.getElementById('currentImage').src = currentImageData.url;

            // Initialize map if needed
            if (!map) {
                initializeMap();
            }

            // Reset map view to world view at start of each trial
            map.setView([40.0, 0.0], 2);

            // Initialize trial data
            studyData.trials[currentTrial - 1] = {
                trialNumber: currentTrial,
                imageUrl: currentImageData.url,
                groundTruth: currentImageData.groundTruth,
                imageDescription: currentImageData.description,
                initialGuess: null,
                initialConfidence: null,
                finalGuess: null,
                finalConfidence: null,
                aiPredictions: [],
                decisionChanged: false,
                confidenceChanged: false,
                timestamp: new Date().toISOString()
            };
        }

        function initializeMap() {
            map = L.map('mapContainer').setView([40.0, 0.0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                
                userMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                
                userMarker.bindPopup('Your guess').openPopup();
                
                const currentTrialData = studyData.trials[currentTrial - 1];
                if (!currentTrialData.initialGuess) {
                    currentTrialData.initialGuess = { lat, lng };
                    // Enable confidence slider and update status
                    document.getElementById('initialConfidenceSlider').disabled = false;
                    document.getElementById('locationStatus').textContent = 'Location selected â';
                    document.getElementById('locationStatus').className = 'status-indicator status-complete';
                    updateInitialGuessButton();
                } else {
                    currentTrialData.finalGuess = { lat, lng };
                    currentTrialData.decisionChanged = true;
                }
            });
        }

        function updateInitialGuessButton() {
            const currentTrialData = studyData.trials[currentTrial - 1];
            const hasLocation = currentTrialData.initialGuess !== null;
            const hasConfidence = currentTrialData.initialConfidence !== null;
            document.getElementById('initialGuessBtn').disabled = !(hasLocation && hasConfidence);
        }

        function showAIPredictions() {
            const currentTrialData = studyData.trials[currentTrial - 1];
            const currentImageData = studyImages[currentTrial - 1];
            
            // Get AI predictions for current condition
            const predictions = currentImageData.aiPredictions[condition];
            currentTrialData.aiPredictions = predictions;
            
            // Display AI predictions
            const aiTeammatesDiv = document.getElementById('aiTeammates');
            aiTeammatesDiv.innerHTML = '';
            
            // Collect all marker coordinates for auto-zoom
            const allMarkerCoords = [];
            if (userMarker) {
                allMarkerCoords.push([userMarker.getLatLng().lat, userMarker.getLatLng().lng]);
            }
            
            predictions.forEach((prediction, index) => {
                const colorInfo = AI_COLORS[index % AI_COLORS.length];
                
                const teammateDiv = document.createElement('div');
                teammateDiv.className = `ai-teammate ${colorInfo.class}`;
                
                const confidenceColor = `hsl(${prediction.confidence * 120}, 70%, 50%)`;
                
                teammateDiv.innerHTML = `
                    <div class="teammate-info">
                        <div class="teammate-label">${prediction.label}</div>
                        <div class="teammate-location">Lat: ${prediction.lat.toFixed(2)}, Lng: ${prediction.lng.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8em; color: #7f8c8d; margin-bottom: 5px;">
                            Confidence: ${Math.round(prediction.confidence * 100)}%
                        </div>
                        <div class="ai-confidence-bar">
                            <div class="ai-confidence-fill" style="width: ${prediction.confidence * 100}%; background: ${confidenceColor};"></div>
                        </div>
                    </div>
                `;
                
                aiTeammatesDiv.appendChild(teammateDiv);
                
                // Create AI marker
                const aiMarker = L.marker([prediction.lat, prediction.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                
                aiMarker.bindPopup(`${prediction.label}<br>Confidence: ${Math.round(prediction.confidence * 100)}%`);
                aiMarkers.push(aiMarker);
                
                // Add to coordinates for auto-zoom
                allMarkerCoords.push([prediction.lat, prediction.lng]);
            });

            // Auto-zoom to fit all markers
            if (allMarkerCoords.length > 1) {
                const group = new L.featureGroup(aiMarkers.concat(userMarker ? [userMarker] : []));
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
            }

            // Set final confidence to initial confidence
            const initialConfidence = currentTrialData.initialConfidence;
            document.getElementById('finalConfidenceSlider').value = initialConfidence;
            document.getElementById('finalConfidenceDisplay').textContent = initialConfidence + '%';
            currentTrialData.finalConfidence = initialConfidence;

            document.getElementById('aiPredictions').style.display = 'block';
            document.getElementById('revisionSection').style.display = 'block';
            document.getElementById('initialGuessBtn').style.display = 'none';
            document.getElementById('finalGuessBtn').style.display = 'inline-block';
        }

        function nextTrial() {
            const currentTrialData = studyData.trials[currentTrial - 1];
            
            // Set final guess if not changed
            if (!currentTrialData.finalGuess) {
                currentTrialData.finalGuess = currentTrialData.initialGuess;
                currentTrialData.decisionChanged = false;
            }

            currentTrial++;
            
            if (currentTrial <= STUDY_CONFIG.totalTrials) {
                updateProgress();
                showLoadingScreen(); // Show loading screen before next trial
            } else {
                // All trials complete
                studyData.timestamps.trialsCompleted = new Date().toISOString();
                showScreen('questionnaireScreen');
            }
        }

        function completeStudy() {
            const trust = document.querySelector('input[name="trust"]:checked');
            const confidence = document.querySelector('input[name="confidence"]:checked');
            const strategy = document.getElementById('strategy').value;
            
            if (!trust || !confidence || !strategy.trim()) {
                document.getElementById('questionnaireError').style.display = 'block';
                return;
            }

            studyData.questionnaire = {
                trust: parseInt(trust.value),
                confidence: parseInt(confidence.value),
                strategy: strategy,
                comments: document.getElementById('comments').value
            };
            
            studyData.timestamps.studyCompleted = new Date().toISOString();

            // Generate completion code
            const completionCode = generateCompletionCode();
            document.getElementById('completionCode').textContent = completionCode;

            // Save data to Google Sheets
            saveDataToGoogleSheets(studyData);
            
            console.log('Study Data:', studyData);
            
            showScreen('completionScreen');
        }

        function generateCompletionCode() {
            return studyData.participantId + '_' + Date.now().toString(36).toUpperCase();
        }

        function saveDataToGoogleSheets(data) {
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                console.log('Google Sheets integration not configured - data logged to console');
                return;
            }

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).then(() => {
                console.log('Data sent to Google Sheets');
            }).catch(error => {
                console.error('Error saving to Google Sheets:', error);
            });
        }

        // Initialize confidence sliders
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            
            // Get URL parameters for Prolific integration
            const urlParams = new URLSearchParams(window.location.search);
            const prolificPid = urlParams.get('PROLIFIC_PID');
            const studyId = urlParams.get('STUDY_ID');
            const sessionId = urlParams.get('SESSION_ID');
            
            if (prolificPid) {
                studyData.prolificPid = prolificPid;
                studyData.studyId = studyId;
                studyData.sessionId = sessionId;
            }

            // Set up confidence slider event listeners
            const initialSlider = document.getElementById('initialConfidenceSlider');
            const finalSlider = document.getElementById('finalConfidenceSlider');
            const initialDisplay = document.getElementById('initialConfidenceDisplay');
            const finalDisplay = document.getElementById('finalConfidenceDisplay');

            if (initialSlider) {
                initialSlider.addEventListener('input', function() {
                    const value = this.value;
                    initialDisplay.textContent = value + '%';
                    if (currentTrial > 0) {
                        studyData.trials[currentTrial - 1].initialConfidence = parseInt(value);
                        updateInitialGuessButton();
                    }
                });
            }

            if (finalSlider) {
                finalSlider.addEventListener('input', function() {
                    const value = this.value;
                    finalDisplay.textContent = value + '%';
                    if (currentTrial > 0) {
                        const currentTrialData = studyData.trials[currentTrial - 1];
                        currentTrialData.finalConfidence = parseInt(value);
                        currentTrialData.confidenceChanged = (parseInt(value) !== currentTrialData.initialConfidence);
                    }
                });
            }
        });
    </script>
</body>
</html>